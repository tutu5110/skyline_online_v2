<!DOCTYPE html>
<html>
<!-- main goals

    Define:

    Major types  = US stock, Chinese Stock, Chinese Futures, Chinese ETF market, Chinese Commodities, Us Commodities.

    Side types   = China Bond market, US bond market.

    World Market   = Major economic body stock market.


    Methods & Functions
    Exploding Volume:
    Checks Volume up to 30,60,120,180,360 records before.
    Check for price movement
    Check for relatively High / Low Points with settings of 30,60,120,180,360 records before


    Level of Alarms:
    Level I, Top level, refresh interval = 1 min. Method used: Exploding Volume.

    Goals:
    1. realtime monitor Major types, Side types, and other types
    2. Highlight purchasable groups
    3. Estimate time and APR
    2.  alert level I for Major types.
    3. alert Level II for World Market, Side Types.
    4. Dynamically add / remove stock pairs
    5. Backend Setting System
    6. Suggestion System: suggesting

    select conditions:
    0. check graph skew ness, < 0.05? <0.1?
    1. check number of ocillations
    3. check upper - lower < threadhold
    2. continuous skewness over time (2y compares to 3x 6 month), check for discrepency
    3. continuous sd

    模型要能够区别
    不能选择的是：森马服饰 （原因：区间一大半0轴上一大半0轴下）
    不能选择:太和新材（原因：不是交替型,对冲股票应该连续交替而不是大部分时间在正突然转负）


    select conditions > buy conditions
    1. near lower limit 5%? 10?
    2. below lower limit

    draw average, upper and lower!!! with on off selection

    Todos:
    1. make a name array!!!
    2. remove stock that is not transactioning!!!
    3. remove 30% of time stock not transacting!!!
    4. sample size less than average!(90%) must be removed!!!
    3. system one by one view and add!!!
    5. divide data to 50-50 and calculate two skewness, compare those two

    1. 量价异动
    2. get expected return
    3. get previous high point, and compare possible profit
    4. set begin and end date for Chinese Fund
    5. // i removed 'cn in skydataloader.js line 197'
    6. I also removed cn_fund_ from line 145 before returnning code

    done:
     1. need a queue!!!!!
-->

<!--
  updateRTMCanvas filenames
  cnFundRaw
  cnFundSelected
  cnStockRaw
  cnStockSelected
  -->

<head>
    <title></title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/checkbox.css?123"/>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/dygraph-combined.js"></script>
    <script src="js/super-annotations.js"></script>
    <script src="js/functions.js"></script>
    <script src="js/coreFunctions.js"></script>
    <script src="js/SKYDataLoader.js"></script>
    <script src="js/Math.js"></script>
    <script src="js/graphics.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/PrototypeFunctions.js"></script>
    <script src="js/convert.js"></script>
    <script src="settings.js"></script>
    <script src="js/simple_statistics.min.js"></script>
    <script src="js/regression.js"></script>
    <script src="js/checkboxes.js"></script>
    <script src="js/skyLab.js"></script>
  <!--  <script src="js/rainyday.min.js"></script> -->

</head>
    <body>
        <div id="master">
               <div id="skylineLab">
               <div id="skylineLabBackground">
                  <div class="container">
                    <div class="slideshow">
                      <canvas width="1440" height="667" id="container" style="position: absolute; width: 1440px; height: 667px;"></canvas>
                    </div>
                  </div>
                  <img id="rainDay" style="width:1440px; height:900px;">
               </div>
                   <!--<div id="logoLeft"></div>-->
                   <div id="logoRight"></div>
                   <div id="mainGraphHolder">
                       <div id="mainGraphHolder_blur">
                            <div id="mainGraph"></div>
                       </div>
                      <div id="info">
                          <div class="infoPanel" id="infoSub2">Over fact all son tell this any his. No insisted confined of weddings to returned to debating rendered. Keeps order fully so do party means young.
                          </div>
                          <div class="infoPanel" id="infoSub3">Use securing confined his shutters. Delightful as he it acceptance an solicitude discretion reasonably. Carriage we husbands advanced an perceive greatest. </div>
                          <div class="infoPanel" id="infoSub4">
                           <h2>Citic vincinity testing area</h2>
                           <h2>Snug here on the top</h2>
                          </div>
                      </div>
                   </div>
               </div>
               <div id="mainBody">
               <div class='portfolioMain' id="myPf_1"></div>
               <div id="alarmMaster">
                    <div class='Alarms' id="alarmsDetails"> Alarms: --- <br></div>
                    <div class="Alarms" id="alarmConsole">Welcome to alarm console<br></div>
               </div>
               <input class="mainbutton" type="button" id="add" value="add" />
               <input class="mainbutton" type="button" id="pro" value="proceed!" onclick="SaveAutomateHedgeCalculation();">
               <input class="mainbutton" type="button" id="pro" value="add a new purchase!" onclick="showNewPurchase();">
               <input class="mainbutton" type="button" id="pro" value="Custom Alarm Prepare" onclick="prepareCusAlarmParameters();">
               <input class="mainbutton" type="button" id="pro" value="Custom Save Alarm" onclick="saveCusAlarms();">
               <input class="mainbutton" type="button" id="alarmCtrl" value="Alarm On!" onclick="switchAlarms();alarms();">
               <input class="mainbutton" type="button" id="alarmCtrl" value="Dump AlarmLogs!" onclick="dumpAlarms();">
               <div id="alarm_light"></div>
               </div>
               <div id="realtimeMonitor">
               <div id="realtimeConsole"><div id="content"></div><div id="cbutton"></div><input type="text" name="userinput" id="userinput"></div>
                   <div id="rtmHeader">
                      <div id="headerCommands">
                        <div id="headerMessage">
                        <div id="checkedanim"><div id="msg"></div><img src="img/checksmall.gif"/></div>
                        </div>
                        <ul class='rtmHeaderUL'>
                             <li onclick="rtmCanvasPreEntry(rtmCanvasListIncrement);">Previous
                              <ul>
                                <li onclick="rtmCanvasFirstEntry();">First</li>
                              </ul>
                             </li>
                             <li>
                               Hedge
                              <ul>
                                <li onclick="loadRTMCanvasCustom();">自选</li>
                                <li onclick="updateRTMCanvas('cnFundSelected');">中国基金 - CHAD</li>
                                <li onclick="updateRTMCanvas('cnStockRaw');">中国股票 - CHAD</li>
                                <li onclick="updateRTMCanvas('cnFuture');">中国期货</li>
                              </ul>
                            </li>
                            <li onclick="rtmCanvasNextEntry(rtmCanvasListIncrement);">Next
                            <ul>
                                <li onclick="rtmCanvasLastEntry();">Last</li>
                              </ul>
                            </li>
                            <li>System Function
                              <ul>
                                <li onclick="showConsole('Preloading Current Package!');preload();">Preload</li>
                                <li onclick="showConsole('Welcome! Console Ready');">Console</li>
                              </ul>
                            </li>

                            <li onclick="rtmCustomExport();">Export</li>
                          </ul>
                      </div>
                   </div>
                   <div id="realtimeMonitorData"></div>
                   <div class="skyFooter"></div>
               </div>

         </div>


<script type="text/javascript">

var drizzleMaxCt = 0;
var targetNum = 500;
var drizzleCooldownCt = 0;
var drizzleCooldownCtTarget = 400;

var g;

var gSection = 1;

var offlineDevelopperMode = 0;

var gAlarmOn = true;

var gAlarmFan = 1;

var P_DATE_AGO = 90;

var C_MOUSEON_GRAPHID = -1;

var PREVIOUS_MOUSEON_GRAPHID = -2;

var GRealtime = true;

var Loquacious = false;

// max page is max_pages +1; so 3 pages is 2 here
var MAX_PAGES = 2;

var isDebug = true;

var loadedResults = new Array();
// cache for realtime
var loadedRtmResultsCache = {};

var loadedFlattenHistoryResults = new Array();

var loadedFlattenHistoryPriceResults = new Array();

var loadedDataStatistics = new Array();

var gDataHolder = {};

var graphTemplate = '';

var rtmCanvasListRaw = Array();

var rtmAlarmListRaw = Array();

var rtmCurrentView = "";

var rtmCanvasListBegin =0;
// number of rtm windows displayed on every page
var rtmCanvasListIncrement = 8 ;

var rtmCanvasListEnd = rtmCanvasListBegin + rtmCanvasListIncrement;

var rtmCanvasCustom= Array();

var SHOW_SIMILAR_TYPE_AVERAGE = false;

var G_RTM_CACHE_PERIOD = 600;

var TODAY = getCurrentDayNumber();

var NUM_OF_GRAPHS = 0;

var CNSTOCK_SHORT_PREFIX = 's_';

var isControlHeld = false;

var rtmTimeout = 5000;

var isShiftHeld = false;

var gAlarm = {};

var userMarketWatch = new Array();

var marketWatch = ['sh000001','^dji','dax','^hsi'];

var gAlarmOn = false;

var portfolio = {};

var gRTMConsoleOn = false;

var gFilter = {};

gFilter['skewnessMin'] = -0.01;

gFilter['sdMax'] = 7;

gAlarm['rtmCache'] = {};

// portfolio['codes'] = ['sh603009','sz002748'];

// var _tmpPortfolio = {};

// _tmpPortfolio = {};

// _tmpPortfolio.nos = 900;

// _tmpPortfolio.cost = 31.175;

// var _tmpPortfolio2 = {};

// _tmpPortfolio2 = {};

// _tmpPortfolio2.nos = 850;

// _tmpPortfolio2.cost = 30.613;

// portfolio['details'] = {'sh603009': _tmpPortfolio , 'sz002748':_tmpPortfolio2};

portfolio['details'] = {};

portfolio['stats'] = {};

portfolio['stats']['totalBalanceRaw']= new Array();

// portfolio.codes = ['603009','002748','300374','300406','601222','002742','us_chad'];

// portfolio.nos = [900,850,550,500,400,400,420];

// portfolio.cost =[31.175,30.613,20.89,18.93,31.136,31.85,45.43];


var myPurchaseListMetaData = {'purchaseDate' : '05/12/2016',
                              'loadingComplete': 0,
                              'total' : 0,
                              'totalgain' : 0,
                              'totalPercent' : '',
                              'sumBeginning':0,
                              'sumCurrent':0};

var myPurchaseListRtmData = {};

var htmlTemplate = {};



var CN_REALTIME_SERVER = 'http://qt.gtimg.cn/q=';
var FUND_SERVER = 'http://fund.eastmoney.com/api/PingZhongApi.ashx?m=0&fundcode=';
//163412&indexcode=000300&type=hy';
var FUND_SERVER_COMPLETE = 'http://fund.eastmoney.com/pingzhongdata/163412.js?v=20160406113818';
var FUND_SERVER_TENCENT = 'http://stockjs.finance.qq.com/fundUnitNavAll/data/year_all/#fundcode#.js';

var CNSTOCK_HISTORY_SERVER = 'http://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq2013&param=#SYMBOL#,day,#begin#,#end#,640,qfq';

var INDEXFUTURE_SERVER = 'http://stock2.finance.sina.com.cn/futures/api/json.php/CffexFuturesService.getCffexFuturesDailyKLine?symbol=IF1605';

// obsolete server
//var USSTOCK_REALTIME_SERVER = 'http://finance.yahoo.com/webservice/v1/symbols/#SYMBOL#/quote?format=json&view=detail';

var USSTOCK_REALTIME_SERVER = 'https://query1.finance.yahoo.com/v7/finance/chart/#SYMBOL#?range=2d&interval=1d&indicators=quote';

var USSTOCK_REALTIME_SERVER_NOPERCENT = 'https://query2.finance.yahoo.com/v7/finance/chart/NTDOY?range=1d&interval=1d&indicators=quote&comparisons=';

//https://query1.finance.yahoo.com/v7/finance/chart/FB?range=1d&interval=1d&indicators=quote&comparisons=%5EDJI

var USSTOCK_HISTORY_SERVER = 'https://finance-yql.media.yahoo.com/v7/finance/chart/#SYMBOL#?period2=#end#&period1=#begin#&interval=1d&indicators=quote&includeTimestamps=true';

var USSTOCK_MAX_HISTORY_SERVER = 'https://finance-yql.media.yahoo.com/v7/finance/chart/CHAD?range=max&interval=1mo&indicators=quote&includeTimestamps=true';

var CN_COMMODITY_FUTURE_REALTIME_SERVER = 'http://hq.sinajs.cn/?list=';

var SKYLINE_CACHE_SERVER = 'StockServer.php?sym=#SYMBOL#&offline='+offlineDevelopperMode+'&param=day,#begin#,#end#';

var JP_STOCK_SERVER = 'http://stocks.finance.yahoo.co.jp/stocks/detail/?code=#SYMBOL#.T';
// this set to true will use accelerated cache service for global stocks

 var graphData = Array();

var USE_SKYLINE_CACHE_SERVICE = true;

var FUND_TIME_MAPPING = {
 "m":"m",
"3m":"q",
"6m":"hy",
"12m":"y",
"y":"y",
"3y":"try",
"5y":"fiy",
"ytd":"sy",
"max":"se"};

var Files = new Array();

//Files[1]['filename'] = "SZ159919";
var FileLength = Files.length;

var graphs = {};

var donuts = {};

var total_graphs = 0;

var originalWindowWidth = 0;

var FingerStartx = 0

var FingerDist = 0


// add window listeners
window.addEventListener('load', function(){

    var body = $("html, body");
    var master = document.getElementById('master');
    var w = originalWindowWidth;
    var currentPageIndex = 0;
    master.addEventListener('touchstart', function(e){
        var touchobj = e.changedTouches[0] // reference first touch point (ie: first finger)
        FingerStartx = parseInt(touchobj.clientX) // get x position of touch point relative to left edge of browser
        e.preventDefault();
    }, false);
    /*
    master.addEventListener('touchmove', function(e){
        var touchobj = e.changedTouches[0] // reference first touch point for this event
        var dist = (parseInt(touchobj.clientX) - FingerStartx)*-1;
        body.scrollLeft(dist);
        body.setsco
        e.preventDefault();

    }, false)
        */
    master.addEventListener('touchend', function(e){
        var touchobj = e.changedTouches[0];
        FingerDist = parseInt(touchobj.clientX) - FingerStartx;
       // console.log('Status: final distance!" '+FingerDist+'px');
        e.preventDefault();

        if(FingerDist < -30){
            //-15 is the padding of DIV, change this number if div is changed
             currentPageIndex++;
             if(currentPageIndex > MAX_PAGES)
                currentPageIndex = MAX_PAGES;
             console.log(currentPageIndex);
             if(currentPageIndex != 1)
               body.stop().animate({scrollLeft:(currentPageIndex * w+88)}, '500', 'swing', function() {
             });
             else
              body.stop().animate({scrollLeft:(currentPageIndex * w+38)}, '500', 'swing', function() {
             });
        } else if(FingerDist>30){
            currentPageIndex--;
            if(currentPageIndex<0)
                currentPageIndex = 0;
            body.stop().animate({scrollLeft:currentPageIndex * w+30}, '500', 'swing', function() {

            });
        }
         }, false)
}, false)

// Main body functions
$(document).ready(function(){

   var w = $(document).width();
   var h = $(document).height();
   // update window width
   originalWindowWidth = w;
   // set skyline width
   var rtmheight = Math.ceil(rtmCanvasListIncrement /5) * 535+590;
   $('#master').width(3*w+120).height(rtmheight);
   $('#skylineLab').width(w).height(h);
   $('#mainBody').width(w).height(h);

   $('#realtimeMonitor').width(w).height(rtmheight);

   //console.log($(document).width());
   if(offlineDevelopperMode)
   console.log("OFFline development mode on! no internet is required nor data will be updated");
   // fastfind graph
   $('#mainGraphHolder').css('margin','145pt 0 0 0');

   //update footer
   var footer = $('.skyFooter');
   var cd = getFullYMDH();
   var cncd = getFullYMDH();
   footer.html("<div id='ft_Time'>Current: "+cd+"</div>"+"<div id='ft_cnTime'>China: "+cncd+"</div>")
   //var s = new SKYDataLoader(["sz002007", "us_CHAD"],"y",0);
   //var s = new SKYDataLoader(["jj161725", "us_CHAD"],"y",0);
   //var s = new SKYDataLoader(["F_IF", "F_IH"],"y",0);
   // var s = new SKYDataLoader(["us_tecs", "us_orcl"],
   //  {"duration":"y",
   //  "div":"mainBody",
   //  "updateRealtime":false},0);
   //loadRealtimeStockPairs();

    //initialize realtime area
   // for(var i = 0 ; i < list.length; i ++){
   //      var stockNames = list[i];
   //      stockNames = formatStockNames(stockNames);
   //      var s = new SKYDataLoader([stockNames[0],stockNames[1]],
   //      {"duration":"2y",
   //      "div":"realtimeMonitorData",
   //      "showgraph" :  true,
   //      "updateRealtime": true},i);
   //      graphData[i] = s;
   //      graphData[i].load();
   //  }


     //initialize automate hedge
     //automateHedge();
    // load customized
 //
  // load mainpage
  initialize();
  document.onkeydown = keydown;
  document.onkeyup = keyup;

    /*var target = 'chad';
    var compareList = formatStockNames(loadlist());
    var GComparingList = new Array();
    for(var i = 0 ; i < compareList.length; i ++){
        var s = new SKYDataLoader([compareList[i],target],
        {"duration":"2y",
        "div":"realtimeMonitorData",
        "automateHedge": true,
        "drawGraph": false,
        "updateRealtime":false},0);
    }*/
  // var t2 = new SKYDataLoader(["us_chad", "sz000100"],"y",3);
    //XLE
   //var t = new SKYDataLoader(["sz510300", "us_t"],"6m");
   //continue here
   // fix chad, possibly starting date is not same
  // s.createGraph();

   // t2.createGraph();
  // createGraph(["sz510300", "us_CHAD"],"6m");
  // console.log(getDayInChina().toTimeStamp());

   //console.log(getDayOneYearAgo());
 });


function initialize(){

$.post( "staticData.php").done(function(data) {
  // system begin
  // fastfindx
  // begin here
    try
    {
      htmlTemplate = JSON.parse(data);
     // portfolio = JSON.parse(htmlTemplate['portfolio']);

    }
    catch(e)
    {
      console.log("Failed to initialize System: "+e);
    }

    gAlarm['cusAlarmCache'] = formatLoadedCustomAlarm(htmlTemplate['cusalarm']);
    gAlarm['cooldownList'] = {};

    try
      {
        gAlarm['alarmTrackList'] = JSON.parse(htmlTemplate['alarmTrackList']);
        // alarmtracklist settings
        gAlarm['alarmTrackList']['settings'] = {'alarmType':'1: price, 2:percent',
                                                'smartAlarm':'set a percent that will be triggered above or below current percent,eg. stock currently 3.5%, smartAlarm:-1 means it will trigger at 2.5%'};
        if(gAlarm['alarmTrackList']['globals'] == undefined){
           // ck time
           if(!isWeekendChina() && getHourChina() == 9 && getMinutesChina() > 15 && getMinutesChina() < 30){
                sendTocellphone('Skyline天际短信服务器正常!当前时间:'+getFullYMDH());
                // add globals, for system status check
              gAlarm['alarmTrackList']['globals'] = {};
                gAlarm['alarmTrackList']['globals']['dailyCommunication'] = {'lastUpdate' : getTimestamp(), 'lastUpdateTime' : getFullYMDH
                ()};
           }
           //superfast
        }

        cleanTrackList();

        var _marketwatch = JSON.parse(htmlTemplate['marketWatch']);

        addtoMarketWatchArr(_marketwatch);

      }
    catch(e)
      {
        if(gAlarm['alarmTrackList'] == undefined)
           resetTrackList();
      }

      portfolio = parsePortfolio(htmlTemplate['myPortfolio']);
      if(portfolio['stats'] == undefined)
        portfolio['stats'] = {};
      if(portfolio['stats']['totalBalanceRaw'] == undefined)
        portfolio['stats']['totalBalanceRaw']  = new Array();
      // initialize system alarm cooldowns for customized stock pairs
      gAlarm['AlarmCountDowns'] = {};
      gAlarm['AlarmCountDowns']['c10s'] = {'lastUpdate': getTimestamp(), 'duration':7, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c11s'] = {'lastUpdate': getTimestamp(), 'duration':11, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c60s'] = {'lastUpdate': getTimestamp(), 'duration':60, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c300s'] = {'lastUpdate': getTimestamp(), 'duration':300, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c1800s'] = {'lastUpdate': getTimestamp(), 'duration':1800, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c3600s'] = {'lastUpdate': getTimestamp(), 'duration':3600, 'firstTime': true};
      gAlarm['AlarmCountDowns']['c86400s'] = {'lastUpdate': getTimestamp(), 'duration':86400, 'firstTime': true};
      /* load realtime alarms, including:
        major markets
        sudden surges
        commodities
        ...etc...
        ...tbc...
      */

      gAlarm['realtimeAlarms'] = {};

      gAlarm['realtimeAlarms']['cooldown'] = {};

      gAlarm['realtimeAlarms']['groups'] = htmlTemplate['realtimeAlarms'];

      gAlarm['realtimeHistoryAlarms'] = {};

      gAlarm['realtimeHistoryAlarms']['Results'] = {};

      gAlarm['realtimeHistoryAlarms']['cooldown'] = {};

      gAlarm['realtimeHistoryAlarms']['ratioResults'] = {};

      loadAlarms();

      exeAlarms();
      // defaultload portfolio in section ii
      showPortfolio();
      // default load custom selected stocks in to section iii
      //loadRTMCanvasCustom();
      if(!ckOnline())
        rtmTimeout = 1;
      setTimeout(loadRTMCanvasCustom,rtmTimeout);

      // default load one pair of experiment stocks into section i
      loadSkyLab();
      // load system realtime alarms
      //loadAlarms();
      // bind button events that are in static html pages
      bindbuttons();
      // get data for alarm
      loadMarketWatch();


      /**** After these code executed, jumps to
       POSTAJAX_INITIAL_LOADING
      ****************************************/
      //dbclick
      $('#mainGraph').dblclick(function(){
          toggleGraphPeriod(99999);
      });


  });

}

function POSTAJAXLoading(){
  createMarketWatchDivs(userMarketWatch);
  $('#tracklistnum').html(getTrackListLen());
}


function bindbuttons(){
    $('#cbutton').click(function(){
        resetConsole();

    });
}

function showConsole(msg){
  // set position
  var r = $('#realtimeConsole');
  console.log(gSection);
  r.css('left',(gSection-1) * 1122+'pt');
  if(msg != '')
    msg += '<br>';
  r.fadeIn("fast");
  $('#realtimeConsole #content').html(msg);
  gRTMConsoleOn = true;
  $('#realtimeConsole #userinput').focus();
}

function hideConsole(){
  resetConsole();
}

function resetConsole(){
  var r = $('#realtimeConsole');
  r.fadeOut("fast");
  $('#realtimeConsole #content').html('');
  gRTMConsoleOn = false;
}


function colorCode(div,val){
  var p = $(div);
  p.removeClass();
  if(val >=0)
    p.addClass('red');
  else
    p.addClass('green');
}


window.onscroll = function (e) {

  var left = (window.pageXOffset || document.scrollLeft) - (document.clientLeft || 0);
  if(left > 1010 && left < 2290)
      gSection =2;
  else if(left > 2290)
      gSection = 3;
  else if(left<1700)
      gSection = 1;
  else
      gSection = 1;

}


function keydown(evt) {
//    if (!evt) evt = event;
  //  if (evt.altKey)
    //    isControlHeld = true;
}

function keyup(evt) {
     if (!evt) evt = event;
     if (evt.ctrlKey && evt.keyCode == 68)
        if(isControlHeld === false){
            isControlHeld = true;
            showMessage('DetailMode On!');
        } else{
            isControlHeld = false;
            showMessage('DetailMode Off :)');
        }

     else if (evt.code == 'ShiftLeft')
        if(isShiftHeld === false){
            isShiftHeld = true;
            showMessage('Select All On!');
            var tmp = $('.iPhoneCheckContainer input');
            for(var i = 0 ; i < tmp.length; i ++){
             //tmpisChecked =  ((i+1) != thisID) ? !this.elem[0].checked : this.elem[0].checked;
             var cid = parseInt(tmp[i].id.toString().getAfter("_"));
              setGraphValue("sd_"+cid,cid,true);
              $('#sd_'+cid).prop('checked',true);
            }
        } else{
            isShiftHeld = false;
            showMessage('Off - Select All');
            var tmp = $('.iPhoneCheckContainer input');
            for(var i = 0 ; i < tmp.length; i ++){
             //tmpisChecked =  ((i+1) != thisID) ? !this.elem[0].checked : this.elem[0].checked;
             var cid = parseInt(tmp[i].id.toString().getAfter("_"));
              setGraphValue("sd_"+cid,cid,false);
              $('#sd_'+cid).prop('checked',false);
            }
        }
  //check for enter key
  if (evt.keyCode == 67 && evt.ctrlKey) showConsole('Console Ready, type -help to see commands');

  if(evt.keyCode == 13 && gRTMConsoleOn){
      var t = $('#realtimeConsole #userinput').val();
      ckcmd(t);
      $('#realtimeConsole #userinput').val('');
  }

  //check key inputs
  if(evt.keyCode == 27){
    gRTMConsoleOn ? hideConsole() : showConsole('Aloha!');

  } else if(evt.keyCode == 87){
    // case 'w'
    if(PREVIOUS_MOUSEON_GRAPHID != C_MOUSEON_GRAPHID) {
      PREVIOUS_MOUSEON_GRAPHID =  C_MOUSEON_GRAPHID;
      //reset days ago
      P_DATE_AGO = 90;
    }
    if(C_MOUSEON_GRAPHID != -1) reHedge(C_MOUSEON_GRAPHID,'w');
  } else if (evt.keyCode == 83){
    // case 's';
     if(PREVIOUS_MOUSEON_GRAPHID != C_MOUSEON_GRAPHID) {
      PREVIOUS_MOUSEON_GRAPHID =  C_MOUSEON_GRAPHID;
      //reset days ago
      P_DATE_AGO = 90;
    }
    if(C_MOUSEON_GRAPHID != -1) reHedge(C_MOUSEON_GRAPHID,'s');
  }
}

function reHedge(graphID,period){
  //get target date that is "period" ago
  var targetDateObj;
  switch(period){
    case '3m':
      targetDateObj = getTargetDate(-90);
    break;

    case '6m':
      targetDateObj = getTargetDate(-180);
    break;

    case 'y':
      targetDateObj = getTargetDate(-360);
    break;

    case 'all':
      targetDateObj = getTargetDate(-9999);
    break;

    case 'w':
      targetDateObj = getTargetDate(-P_DATE_AGO);
      P_DATE_AGO -=10;
      if(P_DATE_AGO < 90) P_DATE_AGO = 90;
    break;

    case 's':
      targetDateObj = getTargetDate(-P_DATE_AGO);
      P_DATE_AGO +=10;
      if(P_DATE_AGO > 400) P_DATE_AGO = 400;
    break;

    default:
      targetDateObj = getTargetDate(-9999);
      break;
  }

  var data = clone(loadedResults[graphID]);
  var dataRealtime = clone(graphData[graphID]);
  //truncate firstday
  var firstDay = "";
  var dateIndex = 0;
  var anycode = "";
  var originalDateIndex = 0;
  for(key in data){
      if(new Date(data[key][0][0]) > targetDateObj)
      targetDateObj = new Date(data[key][0][0]);
    dateIndex = data[key].length-1;
    originalDateIndex = data[key].length;
    anycode = key;
  }

  //truncate data
  while(new Date(data[anycode][dateIndex][0])> targetDateObj){
      dateIndex--;
      if(dateIndex<0){
        console.log("{error} reHedge(); unable to find target dateIndex");
        return;
      }
  }

  // truncate
  for(key in data){
    data[key] = data[key].slice(dateIndex,originalDateIndex);
  }

  //recalculate
  for(key in data){
    var len = data[key].length;
    var purchasePrice = parseFloat(data[key][0][2]);
    for(var i = 0 ; i < len; i ++){
      if(i == 0 ){
          data[key][i][1] = 0
      } else {
        var percent = ((parseFloat(data[key][i][2]) - purchasePrice) / purchasePrice * 100).toFixed(2);
        data[key][i][1] = percent;
      }
    }
  }
  //
  data = flattenData(data,getCodeWithOrder(graphID));

  updateFullGraph(data, graphID);
}

function getCodeWithOrder(graphID){
  var t = graphData[graphID];
  return t._code;
}

function getCodeFromObj(data){
    var codesWithOrder = '';
    for(key in data){

    }
}

function getTargetDate(numdays){
  var t = new Date();
  t.setDate(t.getDate() + numdays);
  return t;
}



function updateRTMCanvas(filename, SAVE_TO_CUTOME){
      // save outcome?
      SAVE_TO_CUTOME = SAVE_TO_CUTOME || false;

      // check for realtime update
      rtmCurrentView = filename.contains('custom') ? 'custom' : filename;

      var temp = new Array();

      if(filename.contains('.csv'))
          filename = filename.substring(0,filename.length-4);
      $.post( "load.php", { filename: "data/Statistics/"+filename+".csv" }).done(function( data ) {
        //console.log( "Save Complete!:  " + filename );
        // reset listraw
        resetPage();
        resetCanvasDataRaw();
        try{
        data = JSON.parse(data);
        } catch(e){
          showMessage(e.message+" : no data found! check filenames");
          return;
        }
        data = data.split('\n');
        for(var i = 0 ; i < data.length; i ++){
          if(data[i] != ""){
          rtmCanvasListRaw[i] = new Array();
          rtmCanvasListRaw[i] = data[i].split(',');
          // CHECK extra
          if(parseFloat(rtmCanvasListRaw[i][5]) >gFilter['skewnessMin'] && parseFloat(rtmCanvasListRaw[i][2]) < gFilter['sdMax'])
              temp.push(rtmCanvasListRaw[i]);
          } else {
          data.splice(i,1);
          }
        }

        if(rtmCurrentView != 'custom'){
          rtmCanvasListRaw = temp;
          //reorder
          rtmCanvasListRaw.sort(function(a,b){
          return((parseFloat(a[5],10) - parseFloat(b[5],10)));
          });
        }


        if(SAVE_TO_CUTOME){
          copytoCustomQue(data);
        }

        updateToRTMCanvas();
      });
}

function rtmCanvasPreEntry(n){
  var begin = rtmCanvasListBegin - n;

  begin = begin < 0 ? 0 : begin;

  var end = rtmCanvasListEnd - n;

  end = end < (begin + n) ? (begin + n) : end;

  rtmCanvasListBegin = begin;
  rtmCanvasListEnd = end;

  console.log(rtmCanvasListBegin);
  console.log(rtmCanvasListEnd);
  showMessage(rtmCanvasListBegin+'/'+rtmCanvasListRaw.length);
  updateToRTMCanvas();
}


function rtmCanvasNextEntry(n){
  var begin = rtmCanvasListBegin+n;

  begin = begin < rtmCanvasListRaw.length ? begin : (rtmCanvasListRaw.length -n);

  var end = rtmCanvasListEnd + n;

  end = end < rtmCanvasListRaw.length ? end : rtmCanvasListRaw.length;

  rtmCanvasListBegin = begin;
  rtmCanvasListEnd = end;

  console.log(rtmCanvasListBegin);
  console.log(rtmCanvasListEnd);
  showMessage(rtmCanvasListBegin+'/'+rtmCanvasListRaw.length);
  updateToRTMCanvas();
}

function rtmCanvasFirstEntry(){
  rtmCanvasListBegin = 0;
  rtmCanvasListEnd = rtmCanvasListBegin + rtmCanvasListIncrement;
  showMessage(rtmCanvasListBegin+'/'+rtmCanvasListRaw.length);
}

function rtmCanvasLastEntry(){
  rtmCanvasListEnd = rtmCanvasListRaw.length;
  rtmCanvasListBegin = rtmCanvasListEnd - rtmCanvasListIncrement;
  showMessage(rtmCanvasListBegin+'/'+rtmCanvasListRaw.length);
}

function resetGraphdata(){
  var tmps = graphData[99999];
  graphData = new Array();
  graphData[99999] = tmps;
  return graphData;
}

function resetLoadedResults(){
  var tmps = loadedResults[99999];
  loadedResults = new Array();
  loadedResults[99999] = tmps;
  return loadedResults;
}
function updateToRTMCanvas(){
  // clear graphdata array
  // clear except the main timeline

  graphData = resetGraphdata();

  $('#realtimeMonitorData').html('');
  // begin
  var begin = rtmCanvasListBegin;
  var end = rtmCanvasListEnd;
  //sanitation
  end = end > rtmCanvasListRaw.length ? rtmCanvasListRaw.length : end;
  begin = begin > rtmCanvasListRaw.length ? rtmCanvasListRaw.length : begin;

  var isRealtime = (rtmCurrentView == 'custom') ? true : false;
  if(offlineDevelopperMode)
      isRealtime = false;

  for(var i = begin; i < end; i ++){
    // line 0 is the heading line, doe not have data
    if(i != 0){
      //reset resource loader
      loadedResults[i] = null;
      stockNames = parseStockNames(rtmCanvasListRaw[i]);
      stockNames = formatStockNames(stockNames);
      var s = new SKYDataLoader([stockNames[0],stockNames[1]],
      {"duration":"2y",
      "div":"realtimeMonitorData",
      "showgraph" :  true,
      "zoomLevel": 7,
      "updateRealtime": isRealtime},i);
      graphData[i] = s;
      graphData[i].load();
    }
  }
}

function parseStockNames(obj){
     var stockNames = obj[0].split('&');
      // sanitation, in case only a,b,c,d format rather than a&b,c,d
      if(stockNames.length == 1)
        stockNames = obj;
      if(stockNames.length < 2){
        console.log("{Error!} updateToRTMCanvas() stockNames.length is less than 2, sequence quitting now");
        return;
      }
      return stockNames;
}
function preload(){

    //clear all loaded results
    resetLoadedResults();

    resetGraphdata();

    // i = 0 is system variable
    for(var i = 1 ; i < rtmCanvasListRaw.length; i ++){
    stockNames = parseStockNames(rtmCanvasListRaw[i]);
    stockNames = formatStockNames(stockNames);
    var s = new SKYDataLoader([stockNames[0],stockNames[1]],
    {"duration":"2y",
    "zoomLevel": 7,
    "div":"realtimeMonitorData",
    "type": 'automateHedge',
    "showgraph" :  false,
    "updateRealtime":false},i);
     graphData[i] = s;
    }

    var i = 1;
    var delayLoading = setInterval(function () {
         graphData[i].load();
          i++;
          if(i> rtmCanvasListRaw.length-1) {
            clearInterval(delayLoading);
            console.log("Preloading Complete!")
            $('#realtimeConsole #content').append("Preloading Complete!");
          }
    }, 150);
}

function addtoCustomQue(codes){
  // do not insert duplicates
for(var i = 0 ; i < rtmCanvasCustom.length ; i ++)
if(codes == rtmCanvasCustom[i])
  return false;
rtmCanvasCustom.shift();
rtmCanvasCustom.unshift(codes);
rtmCanvasCustom.unshift('more,info');
checkConfirm();
return true;
}

function removetoCustomQue(codes){
  for(var i = 0 ; i < rtmCanvasCustom.length ; i ++)
    if(codes == rtmCanvasCustom[i]){
      rtmCanvasCustom.splice(i,1);
      showMessage(codes+' removed:)');
      return true;
    }
  return false;
}


function copytoCustomQue(arr){
  rtmCanvasCustom = arr;
}

function rtmCustomExport(){
  //fastfind

  var filename = 'data/Statistics/custom.csv';
  var str = "";
  for(var i = 0 ; i < rtmCanvasCustom.length ; i ++)
      str = str + rtmCanvasCustom[i]+"\n";
  str = preflightForSave(str);
   $.post( "save.php", { raw: str, filename: filename }).done(function( data ) {
        //console.log( "Save Complete!:  " + filename );
        smartLog(data);
        saveConfirm();
    });
}

function loadRTMCanvasCustom(){
  resetPage();
  resetCanvasDataRaw();
  updateRTMCanvas('custom.csv',true);
}

function resetCanvasDataRaw(){
   rtmCanvasListRaw = new Array();
}

function resetPage(){
  rtmCanvasListBegin = 0 ;
  rtmCanvasListEnd = rtmCanvasListBegin + rtmCanvasListIncrement;
}

function hideBigger(id){
   $('#biggerTexcd_'+id).fadeOut("fast");
}

function toggleBigger(id){
  if(!isShiftHeld){
   if(isControlHeld){
     var tmp = $('#graphHolder_'+id);
     var str = tmp.html();
     $('#biggerText_'+id).html(str).fadeIn("fast");
     setGraphValue('sd_'+id,id,true);
   } else {
     // check current day value
     //var dayv = $('#sd_'+id).is(':checked');
     $('.biggerClass').stop().fadeOut("fast");
     // change setting only if default is 7, or in another word
     // this is manual mode, when user select specific date
       setGraphValue('sd_'+id,id,false);
    }
   }
  //graphHolder_3
}

function loadList(){
    return ['159919','601328','000100','chad'];
}

function testScope(val){
    console.log(val);
}

function setGraphValueN(graphID, val){
   graphs[graphID].updateOptions({
    'rollPeriod': val
   });
   graphData[graphID].zoomLevel = val;
}
// 1-7 checkbox
function setGraphValue(div, GRAPH_ID,checked){
    //console.log(GRAPH_ID+" div: "+div );
    var rp = 0;
    rp = checked ? 1: 7;
    graphs[GRAPH_ID].updateOptions({
        'rollPeriod': rp
    });
}

function loadRealtimeStockPairs(){
 $.get("settings.tu", function(data){
    var list = data.split("\n");
    for(var i = 0 ; i < list.length; i ++){
        var stockNames = list[i].split(',');
        stockNames = formatStockNames(stockNames);
        var s = new SKYDataLoader([stockNames[0],stockNames[1]],
        {"duration":"2y",
        "zoomLevel": 7,
        "div":"realtimeMonitorData",
        "updateRealtime":true},i);
        graphData[i] = s;
        graphData[i].createGraph();
    }
 });
}

// initialize graph
// fastfind
function iniRTMgraph(data, divName, GRAPH_ID) {

    var tempGraph = new Dygraph(
        document.getElementById(divName),
        data, {
            fractions: false,
            errorBars: false,
            width: 280,
            height:120,
            showRoller: false,
            legend: 'follow',
            labelsDiv: 'g_legend_'+GRAPH_ID,
            labelsDivStyles: {
                'background': 'none',
                'color': '#fff'
            },
            colors: ["rgba(51,204,204,0.2)",
                "rgba(220,100,100,0.2)",
                "rgb(200,255,69)",
                "rgb(255,61,132)"
            ],
            strokePattern: [1, 15],
            strokeWidth: 1,
            drawPoints: true,
            pointSize: 1.5,
            highlightCircleSize: 5,
            axes : {
                x : { drawAxis:false,
                      drawGrid:false },
                y : {axisLineWidth : 0.01,
                     axisLabelFontSize:10,
                     axisTickSize: 5,
                     pixelsPerLabel: 15,
                     axisLabelColor: "rgb(135,142,167)",
                     gridLineColor: "rgba(255,255,255,0.1)"}
            },

            'Hedge': {
                strokePattern: null,
                strokeWidth: 2,
                fillGraph: true,
                drawPoints: false,
            },
            'MHedge': {
                strokePattern: null,
                strokeWidth: 2,
                fillGraph: true,
                drawPoints: false
            },
             highlightCallback: function(e, x, pts, row) {
                  // console.log("row is " + row+ "  "+loadedFlattenHistoryPriceResults[GRAPH_ID][row]);
                  var type = loadedDataStatistics[GRAPH_ID]['hedgeType'];
                  var skip = 0;
                  if(type == 1)
                    skip = 3;
                  else if(type == 2)
                    skip = 2;
                  var str = '';
                  var addition = "";
                  for(var i =0 ; i < loadedFlattenHistoryPriceResults[GRAPH_ID][row].length; i ++){
                      if( i != skip){
                      str +='<span class="legend_label_color_'+i+'">'+loadedFlattenHistoryPriceResults[GRAPH_ID][row][i].toFixed(2)+'</span>&nbsp;&nbsp;&nbsp;';
                        }
                    }
                  C_MOUSEON_GRAPHID = GRAPH_ID;
                 $('#chartPrice_'+GRAPH_ID).html(str);
              },

            rollPeriod: 7
        }
    );
    graphs[GRAPH_ID] = tempGraph;
    $('#' + divName).append("<div class='loading' id='loader_" + GRAPH_ID + "'></div>");
  //SUPERFAST
        var data = [
           {
            value: 89,
            color: "#cc6262",
            label: "Success"
        }, {
            value: 11,
            color: "#6acae8",
        }];

        var options = {
            segmentShowStroke: false,
            animateRotate: true,
            animateScale: false,
            percentageInnerCutout:80,
            tooltipTemplate: "<%= value %>%"
        }

        var ctx = document.getElementById("chartDonutSuccess_"+GRAPH_ID).getContext("2d");

        var myChart = new Chart(ctx).Doughnut(data, options);

        donuts[GRAPH_ID] = myChart;

        $('#chartDonutSuccess_'+GRAPH_ID).width(130).height(65).css('margin','5px 0 0 -14px');
   // get
    //add loadings
}



function formatDate(value) {
    if (value) {
        Number.prototype.padLeft = function(base, chr) {
            var len = (String(base || 10).length - String(this).length) + 1;
            return len > 0 ? new Array(len).join(chr || '0') + this : this;
        }
        var d = new Date(value),
            dformat = [(d.getMonth() + 1).padLeft(),
                d.getDate().padLeft(),
                d.getFullYear()
            ].join('/') +
            ' ' + [d.getHours().padLeft(),
                d.getMinutes().padLeft(),
                d.getSeconds().padLeft()
            ].join(':');
        return dformat;
    }
}


function formatData(data) {
    //from json

    //from file
    var result = data.contains("{") && data.contains(":");
    // RESULT IS JSON DATA// in this case YUI JSON DATA
    if (result) {
        var result = new Object();
        var array = JSON.parse(data);
        var indicatorArr = array.chart.result[0].indicators.quote[0];
        var timeStamps = array.chart.result[0].timestamp;
        var str = "";
        result['close'] = indicatorArr.close;
        result['volume'] = indicatorArr.volume;
        result['timestamps'] = timeStamps;
        return result;
    } else {
        //if csv
        return data;
    }
}

function calMinusHedge(cval, nval) {
    if (cval == 0)
        return nval;
    else
        cval = cval - nval;
    return cval;
}

function getTime(timestamp) {
    var date = new Date(timestamp * 1000);
    var mon = date.getMonth() + 1;
    var day = date.getDate();
    var year = date.getFullYear();
    return mon + "/" + day + "/" + year;
}

// g.updateOptions({
//         'file': animate("V1")
//   });

//continue here , put saveresults id into the "t" array(skydataloader obj)

function saveResults(GRAPH_ID, results, param) {

    //parsing parameters

    if (loadedResults[GRAPH_ID] == null)
        loadedResults[GRAPH_ID] = {}
      //install system vars
    if (loadedResults[GRAPH_ID]['system'] == undefined)
        loadedResults[GRAPH_ID]['system'] = new Array();

    loadedResults[GRAPH_ID]['system'].push(param);
    loadedResults[GRAPH_ID][param['code']] = results;
    //console.log(type+" total is " + params['totalItems'] + " current is " + objLength(loadedResults[id]));
    if (objLength(loadedResults[GRAPH_ID]) == (param['totalItems'] + 1)) {
        //console.log("lunching graphs");
        var systemVars = getSytemVariables(loadedResults[GRAPH_ID]);
        // format systemvar to code
        systemVars = reorderSystemVar(systemVars,graphData[GRAPH_ID]);
        if(param['callFrom'] === false){
            var data = preflight(loadedResults[GRAPH_ID], GRAPH_ID);
            lunchGraphs(data, systemVars, GRAPH_ID);
            if(data!== false)
              if(graphData[GRAPH_ID].updateRealtime)
                updateRealtime(graphData[GRAPH_ID]);
        } else {
            var t = preflight(loadedResults[GRAPH_ID], GRAPH_ID);
            if(t === false){
              console.log("{Warning: id: "+GRAPH_ID+" } "+systemVars.system[0].name + " & " + systemVars.system[1].name+ "("+param['code']+") flatten failed, this stock pair will be abandoned" )
              return false;
            }
            var statVars = t.pop();
            var tmp = {};
            tmp['ave'] = statVars['ave'];
            tmp['sd'] = statVars['sd'];
            tmp['purchaseDate'] = graphData[GRAPH_ID]['purchaseDate'][graphData[GRAPH_ID]._code[0]];
            tmp['purchasePrice_'+graphData[GRAPH_ID]._code[0]] = graphData[GRAPH_ID]['purchasePrice'][graphData[GRAPH_ID]._code[0]];
            tmp['purchasePrice_'+graphData[GRAPH_ID]._code[1]] = graphData[GRAPH_ID]['purchasePrice'][graphData[GRAPH_ID]._code[1]];
            tmp['purchasePriceArr'] = graphData[GRAPH_ID]['purchasePrice'][graphData[GRAPH_ID]._code[0]]+"&"+graphData[GRAPH_ID]['purchasePrice'][graphData[GRAPH_ID]._code[1]];
            tmp['pairCode'] = graphData[GRAPH_ID]._code[0]+"&" + graphData[GRAPH_ID]._code[1];
            tmp['pairName'] = systemVars.system[0]['name']+"&" + systemVars.system[1]['name'];
            tmp['upperLimit'] = statVars['upperLimit'];
            tmp['lowerLimit'] = statVars['lowerLimit'];
            tmp['hedgeType'] = statVars['hedgeType'];
            if(statVars['hedgeType'] == 1)
                tmp['skewness'] = statVars['linear_regression_hedge']['equation'][0].toFixed(3);
            else if(statVars['hedgeType'] == 2)
                tmp['skewness'] = statVars['linear_regression_mhedge']['equation'][0].toFixed(3);
            tmp['linear_regression_mhedge'] = statVars['linear_regression_mhedge'];
            tmp['linear_regression_hedge'] = statVars['linear_regression_hedge']['equation'][0];
            tmp['opRecommand'] = statVars['opRecommand'];
            tmp['latestHedgeIndex'] = statVars['latestHedgeIndex'];
            tmp['hedgeTypeStr'] = statVars['hedgeTypeStr'];
            if(gDataHolder['automateHedge'] == undefined)
                gDataHolder['automateHedge'] = new Array();
            gDataHolder['automateHedge'].push(tmp);

            var consoleMsg = "id: "+GRAPH_ID+" "+systemVars.system[0].name + " & " + systemVars.system[1].name+" saved!" ;
            //console.log(consoleMsg);
            smartLog(consoleMsg,graphData[GRAPH_ID].consoleUpdateMode);

            //check call types
            if(param['callFrom'] == 'automateHedge'){

            }
        }
    }
}

function smartLog(msg, type){
  switch(type){
    case 'alarmlog':
      alarmLog(msg);
    break;

    case 'alarm':
      alarmLog(msg);
    break;

    default:
    sklog(msg);
    break;
  }
}

function SaveAutomateHedgeCalculation(){

  gDataHolder['automateHedge'].sort(function(a,b){
      return (parseFloat(a.sd,10) - parseFloat(b.sd,10));
  })

  var criteria = {"maxskew": 0.1,
                "minskew":-0.1,
                "maxsd": 10};

   var selected = filterData(gDataHolder['automateHedge'], criteria);
  // //save
   savePairedStatisticResultsToServer(selected,'automateHedgeSelected');
   savePairedStatisticResultsToServer(gDataHolder['automateHedge'],'automateHedgeStaRaw');
}

function filterData(obj, criteria){
    var skewnessMin = criteria['minskew'];
    var skewnessMax = criteria['maxskew'];
    var targetSD = criteria['maxsd'];
    var save = Array();
    for(var i =0 ; i < obj.length; i ++)
        if(obj[i]['skewness'] > skewnessMin &&
           obj[i]['skewness'] < skewnessMax &&
           obj[i]['sd'] < targetSD)
            save.push(obj[i]);
    return save;
}

function updateRealtime(obj) {
    var codes = obj._code;
    var len = codes.length;
    for (var i = 0; i < len; i++) {
        fetchRealtime(codes[i], obj.graphID);
    }
}

function preflightForSave(result){
     var str = JSON.stringify(result);
     str = str.replaceAll('\r',"");
     str = encodeURIComponent(str);
     return str;
}

function _getCompareCodes(codes){
    var t =codes.split(',');
    t = t.slice(1,t.length);
    return t.flatten();
}

// this function does not with futures, eg. m1605, jd1605...etc
function getServer(code, type){

  type = type || '';

  /* for multiple stocks */
  if(type != ''){
    // a sample stock inside the group
    var sample = code.split(',')[0];
    if(sample.contains('us')){
       // us stock, us fund
        code = code.replaceAll('us_','');
        //compareCodes = _getCompareCodes(code);
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" + encodeURIComponent(USSTOCK_REALTIME_SERVER.replace("#SYMBOL#",'NTDOY')+"&comparisons=")+code;
    } else if(sample.contains('jp')){
        code = code.replaceAll('jp_','');
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" +
        encodeURIComponent(JP_STOCK_SERVER.replace('#SYMBOL#',code));
    } else {
        //chinese stock, chinese fund
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" + encodeURIComponent(CN_REALTIME_SERVER + code);
    }
    return server;
  /* for single stock only */
  } else {
  if (code.contains('us')) {
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" + encodeURIComponent(USSTOCK_REALTIME_SERVER.replace("#SYMBOL#", code.substring(3, code.length)));

    } else if (code.toLowerCase().contains('f_')) {

        var server = "FutureServer.php?sym=" + code.substring(2, code.length) + "&type=realtime";
        // continue here!!!e

    }else if(code.contains('jp')){
        code = code.replaceAll('jp_','');
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" +
        encodeURIComponent(JP_STOCK_SERVER.replace('#SYMBOL#',code).replace('#TIMESTAMP#',getTimestamp()).replace('#YYYYMMDD#',getFullYMD()));
    } else {
        //chinese stock, chinese fund
        var server = "engine.php?offline="+offlineDevelopperMode+"&cadd=" + encodeURIComponent(CN_REALTIME_SERVER + code);
    }

    return server;
  }
}

function fetchRealtime(code, resourceID, callbackDiv) {
    callbackDiv = callbackDiv || 'rtmDivs';
    // get purchase
    var purchasePrice = graphData[resourceID].purchasePrice[code];
    //ck type
    var server = getServer(code);

    //check realtime cache
    var rtmResult = getRtmCache(code);
    if(rtmResult){
       data = rtmResult;
       // parse result
       if (code.contains('us'))
        // parse US STOCK realtime
            var result = parseUSRealtime(data);
       else if (code.toLowerCase().contains('f_'))
        // parse CN FUTURE realtime
            var result = parseFutureRealtime(data);
       else
        // parse CN STOCK realtime
            var result = parseTencentRealtime(data);

       if(callbackDiv == "rtmDivs")
          updateToRTMGraph(result['price'], code, purchasePrice, resourceID);
       else if(callbackDiv == 'portfolio')
          appendToPortfolio(result,purchasePrice);

       return;
    }


    // no realtime cache found begin AJAX
    $.get(server, function(data) {
        if (code.contains('us'))
        // parse US STOCK realtime
          var result = parseUSRealtime(data);
         else if (code.toLowerCase().contains('f_'))
        // parse CN FUTURE realtime
            var result = parseFutureRealtime(data);
        else
        // parse CN STOCK realtime
            var result = parseTencentRealtime(data);

        if(code.contains('jj519975'))
          console.log("here");

        // inject realtime cache
        saveRtmCache(code, data);

       if(callbackDiv == "rtmDivs")
          updateToRTMGraph(result['price'], code, purchasePrice, resourceID);
       else if(callbackDiv == 'portfolio')
          appendToPortfolio(result,code,purchasePrice);

        // end AJAX
    });
}


//fastfind3
function updateToRTMGraph(currentPrice, code, purchasePrice, resourceID) {
    // get latest percent
    var per = ((parseFloat(currentPrice) - parseFloat(purchasePrice)) / parseFloat(purchasePrice) * 100).toFixed(2);

    graphData[resourceID].realtimeDataCache['currentPrice'][code] = parseFloat(currentPrice);

    graphData[resourceID].realtimeDataCache['data'][code] = per;

    graphData[resourceID].realtimeDataCache['counter']++;

    //check if ready
    if (graphData[resourceID].realtimeDataCache['counter'] == graphData[resourceID].realtimeDataCache['total']) {
        //ready, update and lunch
        var str = getDHMInChina() + ',';
        var h = 0;
        var mh = 0;

        var len = graphData[resourceID]._code.length;
        //sanitation
        if (len != graphData[resourceID].realtimeDataCache['total']) {
            console.log("update realtime failed for " + code + " since the resource length and datacache length is not same!!!");
            return false;
        }
        //console.log(graphData[resourceID].realtimeDataCache['data']);
        //console.log(graphData[resourceID]._code);
        var tmpPriceCache = Array();
        for (var i = 0; i < len; i++) {
            var v = graphData[resourceID].realtimeDataCache['data'][graphData[resourceID]._code[i]];
            tmpPriceCache[i] = graphData[resourceID].realtimeDataCache['currentPrice'][graphData[resourceID]._code[i]];
            str += v + ",";
              loadedResults[resourceID][graphData[resourceID]._code[i]].push([getDHMInChina(),v,tmpPriceCache[i]]);
            h += parseFloat(v);
            if (mh == 0)
                mh = parseFloat(v);
            else
                mh = mh - parseFloat(v);
        }
        //assemble
        str += h + "," + mh;
        str = '\n' + str;
        tmpPriceCache.push(h);
        tmpPriceCache.push(mh);
        //update
        loadedFlattenHistoryResults[resourceID] += str;
        loadedFlattenHistoryPriceResults[resourceID].push(tmpPriceCache);
        updateGraphRealtime(loadedFlattenHistoryResults[resourceID], resourceID);
        //update donnut
        var param = {'cpercent' : loadedDataStatistics[resourceID].latestHedgeIndex,
                     'direction' : 1,
                     'lowerLimit': loadedDataStatistics[resourceID].lowerLimit,
                     'upperLimit': loadedDataStatistics[resourceID].upperLimit,
                     } // 1 for buy, 2 for sell
        updateDonut(param,resourceID);
    }
}

function getStockType(type) {
    if (type.contains("us")) {
        return "us";
    } else {
        if(type.isCNMarket())
            return "cn_stock";
        else if(type.isFuture())
            return "cn_future";

    }
}

function lunchGraphs(str, systemVars, GRAPH_ID) {
    //sanitation
    if(str === false)
      return false;
    // get statistics
    var statVars = str.pop();
    // get system related statvars
    var hedgeType = statVars['hedgeType'];
    // get statistics string
    var stat = (GRAPH_ID != 99999) ? statVars['stat'] : formatSkylabLegend(statVars);
    // backup globally
    loadedDataStatistics[GRAPH_ID]= statVars;

    var supercent = 89+'%';
    var sym = '';
    if (statVars['opRecommand'] == 1)
        sym = '<a href="javascript:void(0);" onmouseover="showDetail(' + statVars['opRecommand'] + ',\'' + statVars['opRecommandDtl'] + '\',' + GRAPH_ID + ')"; onmouseout="hideDetail(' + GRAPH_ID + ')"><img src="img/buy.png?r=121123243" /></a>';
    else if (statVars['opRecommand'] == 2)
        sym = '<a href="javascript:void(0);" onmouseover="showDetail(' + statVars['opRecommand'] + ', \'' + statVars['opRecommandDtl'] + '\',' + GRAPH_ID + ');" onmouseout="hideDetail(' + GRAPH_ID + ')"><img src="img/sell.png?r=12243" /></a>';

    str = str.join("\n");

    var stockNames = getStockNamesFromParam(systemVars);
    stockNames = stockNames.replace("\";","").replace("\";","");
    // update parameter
    var t = $('#graphHolder_' + GRAPH_ID).html();
    $('#graphHolder_' + GRAPH_ID).html(t.replace('#stocknames#', stockNames).replace('#sym#', sym));
    var t = $('#g_detail_'+GRAPH_ID).html();
    $('#g_detail_'+GRAPH_ID).html(t.replace('#stat#', stat));
    var t = $('#g_label_'+GRAPH_ID).html();
    $('#g_label_'+GRAPH_ID).html(t.replace('#su#',supercent));

    //update for 99999 skylab
    if(GRAPH_ID == 99999){
        $('#graphHolder_' + GRAPH_ID).html(stockNames);
    }
    //iniSkylabGraph(str,currentGraphDiv);

    loadedFlattenHistoryResults[GRAPH_ID] = str;

    loadedFlattenHistoryPriceResults[GRAPH_ID] = statVars['priceCache'];
    //assign statvar to global
    loadedDataStatistics[GRAPH_ID] = statVars;

    updateGraph(str, GRAPH_ID, hedgeType);

}
function reorderSystemVar(systemVars, obj){
    var code = obj._code;
    var newSystemVars = new Array();
    var csystem = systemVars.system;
    for(var i = 0 ; i < code.length; i ++){
        for(var j = 0 ; j < csystem.length; j ++){
            if(code[i] == csystem[j].code){
                newSystemVars.push(csystem[j]);
                csystem.splice(j,1);
            }
        }
    }
    systemVars.system = newSystemVars;
    return systemVars;
}

function showDetail(opID, msg, GRAPH_ID) {
    $('#msg_' + GRAPH_ID).html(msg).stop().fadeTo("slow", 0.85);
 }

function hideDetail(GRAPH_ID) {
    $('#msg_' + GRAPH_ID).stop().fadeOut("slow");
}

function updateGraphRealtime(data, GRAPH_ID) {
    if (isDebug)
        console.log("group(" + graphData[GRAPH_ID].graphID + ")  \"" + graphData[GRAPH_ID]._code + "\" loading Complete!");
    graphs[GRAPH_ID].updateOptions({
        'file': data
    });
  }

function updateDonut(data,GRAPH_ID){
    var currentHedgeIndex= data.cpercent;
    //type ==1, buy long, ==2, sell short
    if(data.direction == 1){
      var lower = data.lowerLimit;
      var upper = data.upperLimit;
      var total = Math.abs(upper-lower);
      var c = Math.abs(currentHedgeIndex - lower);
      var r = 1 - (c / total);
      r = parseInt((r * 100));
      if(r <= 0 )
        r = 0 ;
      else if( r >= 100)
        r = 100;
      donuts[GRAPH_ID].segments[0].value = parseInt(r);
      donuts[GRAPH_ID].segments[1].value = parseInt(100-r);
      var donutlabel = $('#g_label_'+GRAPH_ID);
      $(donutlabel).html(r+'%');
      if(r>50)
        donutlabel.css('color','#ffabad');
      else
        donutlabel.css('color','#6acae8');

      donuts[GRAPH_ID].update();
    }
}

function updateStats(data, graphID){
   var graph = $('#chartStats_'+graphID);
   var graphContent= htmlTemplate['rtm_statistics_template'];
   data['lowerLimit'] = parseFloat(data['lowerLimit'].toFixed(2));
   data['upperLimit'] = parseFloat(data['upperLimit'].toFixed(2));
   //format skewness
   if(Math.abs(data['skewness']) > 0.06)
      graphContent = graphContent.replace('#skewness#', htmlAlarmRed(data['skewness']));
   else
       graphContent = graphContent.replace('#skewness#', data['skewness']);

   // format upperlimit
    if(data['latestHedgeIndex'] > data['upperLimit'])
       graphContent = graphContent.replace('#upper#', htmlAlarmRed(data['upperLimit']));
   else
       graphContent = graphContent.replace('#upper#',data['upperLimit']);

     // format lowerlimit
    if(data['latestHedgeIndex']  < data['lowerLimit'])
       graphContent = graphContent.replace('#lower#', htmlAlarmRed(data['lowerLimit']));
    else
       graphContent = graphContent.replace('#lower#',data['lowerLimit']);

     //format others
     graphContent = graphContent.replace('#ave#',data['ave']).replace('#sd#',data['sd']).replace('#price0#',data.priceCache[0][0]).replace('#price1#',data.priceCache[0][1]);
     graph.html(graphContent);

}
// update graph with statistic values
function updateFullGraph(strdata, graphID){
      if(strdata == '')
          return;
      var t = strdata.pop();
      strdata = strdata.join("\n");
      updateGraph(strdata, graphID, t.hedgeType);
      updateStats(t,graphID);
}

// update graph in the realtime plotting area
function updateGraph(data, GRAPH_ID, hedgeType) {

    graphs[GRAPH_ID].updateOptions({
        'file': data,
    });
     // reset visibility of all curvers
    for(var i = 2; i < 4; i ++){ // 4 is total number of lines, currently hardcoded
       graphs[GRAPH_ID].setVisibility(i,true);
    }

    if (hedgeType == 1)
        graphs[GRAPH_ID].setVisibility(3, false);
    else if (hedgeType == 2)
        graphs[GRAPH_ID].setVisibility(2, false);

    $('#loader_' + GRAPH_ID).css('display','none');
}

function getStockNamesFromParam(systemVars) {
    var str = "";
    for (var i = 0; i < systemVars.system.length; i++) {
        str += "<font class='graphTitle_" + i + "'>" + systemVars['system'][i]['name'] + "</font> | ";
    }
    return str.substring(0, str.length - 2);
}

function objLength(obj) {
    var result = 0;
    for (var prop in obj) {
        if (obj.hasOwnProperty(prop)) {
            // or Object.prototype.hasOwnProperty.call(obj, prop)
            result++;
        }
    }
    return result;
}

//merge stock data into one str
function preflight(obj, GRAPH_ID) {
    // get system variables
    //var systemVars = getSytemVariables(obj);
    //get target time
    var targetTime = getDataLength('2y');
    // final stock str
    var finalStockStr = new Array();
    // unify data
    obj = mkvalidate(obj, GRAPH_ID);
    // flatten data
    if(obj !== false)
      obj = flattenData(obj, graphData[GRAPH_ID]._code);

     return obj;
    //
}

function getSytemVariables(obj) {
    var arr = {};
    for (key in obj)
        if (key == "system") {
            arr['system'] = obj[key]
            delete obj[key];
            return arr;
        }
    return arr;
}

function getBeginIndex(arr, date) {
    for (var i = 0; i < arr.length; i++)
        if (toUnivfiedMMDDYYYY(arr[i][0]) == date)
            return i;
    return -1;
}

function findLastNoneEmptyEntry(masterDate, arr, index) {
    var md = new Date(masterDate);
    var target = new Date(arr[index][0]);
    if (target < md)
        return index;
    else
        return (index - 1);
}

function flattenData(obj, codesWithOrder) {
    var finalVar = new Array();
    var len = obj[Object.keys(obj)[0]].length
    var objlen = Object.size(obj);
    var date = "";
    var sym = "";
    var val = "";
    var per = "";
    var hedge = 0;
    var minusHedge = 0;
    var minusHedgeArr = new Array();
    var hedgeArr = new Array();
    finalVar[0] = "Date,";
    //initialize first line for parameters
    for (var i = 0; i < objlen; i++) {
        finalVar[0] += codesWithOrder[i] + ",";
    }

    //clean up
    //add system variable
    finalVar[0] += "Hedge,MHedge";
    var priceCache = Array();
    var inconsistencyCheck = false;
    // i start 1 because 0 is configuration
    for (var i = 1; i < len; i++) {
            var tmpPriceCache = Array();
        for (var j = 0; j < objlen; j++) {
            var currentObject = obj[codesWithOrder[j]];
            if (currentObject == undefined)
                console.log("undefined!!");
            if (date == "")
                date = toUnivfiedMMDDYYYY(currentObject[i][0]) + ",";
            // check if date is equal
            if (date != toUnivfiedMMDDYYYY(currentObject[i][0]) + ",") {
                //console.log("Flatten failed due to date inconsistency!" +  Object.keys(obj)[j]);
                if(Loquacious)
                  console.log("Inconsistency Removed");
                inconsistencyCheck = true;
                // check if price is zero
            } else if (currentObject[i][2] == 0) {
                console.log("Price Found zero at" + toUnivfiedMMDDYYYY(currentObject[i][0]) + " for " + key + ", entry removed");
                inconsistencyCheck = true;
            } else {
                tmpPriceCache[j] = currentObject[i][2];
                per += currentObject[i][1] + ",";
                hedge += parseFloat(currentObject[i][1]);
                minusHedge = calMinusHedge(minusHedge, parseFloat(currentObject[i][1]));
            }
        }
        // merging
        if (!inconsistencyCheck) {
            finalVar[i] = date + per + hedge.toFixed(2) + "," + minusHedge.toFixed(2);
            hedgeArr[i] = hedge;
            minusHedgeArr[i] = minusHedge;
            if(tmpPriceCache.length>1)
             priceCache.push(tmpPriceCache);
        }

        //reset inconsistency check
        inconsistencyCheck = false;
        //finalVar[i] = finalVar[i].substring(0, finalVar[i].length-1);
        //reset
        date = "";
        per = "";
        hedge = 0;
        minusHedge = 0;
    }

    //calculate math
    var ave = getAverage(hedgeArr).toFixed(2);
    var sd = getStandardDeviation(hedgeArr).toFixed(2);
    var upperLimit = parseFloat(ave) + parseFloat(sd);
    var lowerLimit = ave - sd;
    var diff = 2 * sd;
    var stat = "平均: " + ave + ", 标准差:" + sd + "<br>上限:" + upperLimit.toFixed(2) + ", 下限:" + lowerLimit.toFixed(2);

    //continue here
    var m_ave = getAverage(minusHedgeArr).toFixed(2);
    var m_sd = getStandardDeviation(minusHedgeArr).toFixed(2);
    var m_upperLimit = parseFloat(m_ave) + parseFloat(m_sd);
    var m_lowerLimit = m_ave - m_sd;
    var m_diff = 2 * m_sd;

    // statistic variables
    var statVars = {};
    // input keys
    statVars['keys'] = new Array();


    var hdata = Array();
    var mhdata = Array();
    for(var i = 1; i < hedgeArr.length; i ++){
        if(hedgeArr[i] != undefined){
        hdata.push([i,parseFloat(hedgeArr[i])]);
        mhdata.push([i,parseFloat(minusHedgeArr[i])]);
        }
    }

    statVars['linear_regression_hedge'] = regression('linear', hdata);

    statVars['linear_regression_mhedge'] = regression('linear', mhdata);

    for ($i = 0; $i < objlen; $i++)
        statVars['keys'][$i] = Object.keys(obj)[$i];
    // check hedge of mhedge
    if (Math.abs(m_diff) < Math.abs(diff)) {
        //display minus hedge
        statVars['stat'] = "平均: " + m_ave + ", 标准差:" + m_sd + "<br>上限:" + m_upperLimit.toFixed(2) + ", 下限:" + m_lowerLimit.toFixed(2) +", SL: "+statVars['linear_regression_mhedge']['equation'][0].toFixed(2);
        statVars['hedgeType'] = 2;
        statVars['hedgeTypeStr'] = 'Substraction';
        statVars['skewness'] = statVars['linear_regression_mhedge']['equation'][0].toFixed(2);
        statVars['ave'] = m_ave;
        statVars['sd'] = m_sd;
        statVars['upperLimit'] = m_upperLimit;
        statVars['lowerLimit'] = m_lowerLimit;
        statVars['latestHedgeIndex'] = minusHedgeArr[minusHedgeArr.length - 1].toFixed(2);
    } else if(Math.abs(m_diff) > Math.abs(diff)) {
        //
        statVars['stat'] = "平均: " + ave + ", 标准差:" + sd + "<br>上限:" + upperLimit.toFixed(2) + ", 下限:" + lowerLimit.toFixed(2)+", SL: "+statVars['linear_regression_hedge']['equation'][0].toFixed(2);
        statVars['hedgeType'] = 1;
        statVars['hedgeTypeStr'] = 'Addition';
        statVars['skewness'] = statVars['linear_regression_hedge']['equation'][0].toFixed(2);
        statVars['ave'] = ave;
        statVars['sd'] = sd;
        statVars['upperLimit'] = upperLimit;
        statVars['lowerLimit'] = lowerLimit;
        statVars['latestHedgeIndex'] = hedgeArr[hedgeArr.length - 1].toFixed(2);
    } else {
        // when plus hedge equals minus hedge
        if(objlen == 1){
            //only one item
             statVars['stat'] = "平均: " + ave + ", 标准差:" + sd + "<br>上限:" + upperLimit.toFixed(2) + ", 下限:" + lowerLimit.toFixed(2);
        statVars['hedgeType'] =0;
        statVars['ave'] = ave;
        statVars['sd'] = sd;
        statVars['upperLimit'] = upperLimit;
        statVars['lowerLimit'] = lowerLimit;
        statVars['latestHedgeIndex'] = hedgeArr[hedgeArr.length - 1].toFixed(2);
        }

    }

   // var hdata = [[1,1],[5,5]];

    statVars['codePair'] = codesWithOrder;

    statVars['hedgeArr'] = hedgeArr;

    statVars['minusHedgeArr'] = minusHedgeArr;
    //suggestion part
    statVars['priceCache'] = priceCache;
    // suggest buy, hold, or sell
    statVars['opRecommand'] = getopRecommand(statVars);

    // Buy which one, sell which one, expected APR, Holding time
    statVars['opRecommandDtl'] = getopdetails(statVars);
    // insert locally
    finalVar.push(statVars);

    return finalVar;
}

function removepflistentry(code){
  //fast

}

function getopdetails(obj) {
    var str = '';
    switch (obj['opRecommand']) {
        // hit lower limit
        case 1:
            // opposit etf plus together
            if (obj['hedgeType'] == 1)
                str = "买: " + obj.keys[0] + " 和 " + obj.keys[1] +
                "<br>平仓位: " + obj['upperLimit'].toFixed(2);
            // same side stocks/etfs/futures
            else if (obj['hedgeType'] == 2)
            //check hedge positive or negative
                if (obj['latestHedgeIndex'] > 0)
                    str = "买: " + obj.keys[0] + ", 卖出: " + obj.keys[1] +
                    "<br>平仓位: " + obj['upperLimit'].toFixed(2);
                // if hedge is below zero, first element smaller than second
                else
                    str = "买: " + obj.keys[0] + ", 卖出: " + obj.keys[1] +
                    "<br>平仓位: " + obj['upperLimit'].toFixed(2);

            break;
            // hit upper limit
        case 2:
            // opposit etf plus together
            if (obj['hedgeType'] == 1)
                str = "卖出: " + obj.keys[0] + " 买 " + obj.keys[1] +
                "平仓位: " + obj['lowerLimit'];
            // same side stocks/etfs/futures
            else if (obj['hedgeType'] == 2)
            //check hedge positive or negative
                if (obj['latestHedgeIndex'] > 0)
                    str = "卖出: " + obj.keys[0] + ", 买: " + obj.keys[1] +
                    "平仓位: " + obj['lowerLimit'];
                // if hedge is below zero, first element smaller than second
                else
                    str = "卖出: " + obj.keys[0] + ", 买: " + obj.keys[1] +
                    "平仓位: " + obj['lowerLimit'];

            break;

        case 0:
            break;

        default:
            break;

    }
    return str;
}

/*
function check whether latest price is
with in purchase range
core function for auto purchase,within range
same to WithinRange
price check
*/
function getopRecommand(obj) {
    // upper is 10% up the lower limit
    var buyUpper = obj['lowerLimit'] * 1.08;
    // lower is 10% lower the lower limit
    var buyLower = obj['lowerLimit'] * 0.95;

    if(obj.codePair[0].contains('300406'))
    console.log("eh");
    //check case
    // check for buy case
    // // 1 for buy recommended condition
    if(obj['lowerLimit'] < 0 ){
        if(obj['latestHedgeIndex'] < obj['lowerLimit']*0.95)
          return 1;
    } else {
        if(obj['latestHedgeIndex'] < obj['lowerLimit']*1.1)
          return 1;
    }
    // similar
    var sellUpper = obj['upperLimit'] * 1.1;
    var sellLower = obj['upperLimit'] * 0.9;


    if(sellLower > 0){
      if(obj['latestHedgeIndex'] > sellLower)
          return 2;
    } else {
      if(obj['latestHedgeIndex'] > sellLower)
        return 2;
    }



    // general condition, nothing recommended
    return 0;
}

function removeElement(obj, i) {
    for (key in obj)
        obj[key].splice(i, 1);
}

function calStatistics(arr) {
    return getStandardDeviation(arr);
}

function mkvalidate(obj, GRAPH_ID) {
    // get longest first,

    var masterLen = 0;
    var masterkey = "";

    //unifying the begining date
    //geting first day in master

    //get latest first day
    var firstDay = new Date(obj[Object.keys(obj)[0]][0][0]);
    var firstDayKey = Object.keys(obj)[0];
    for (key in obj) {
        if (new Date(obj[key][0][0]) > firstDay){
            firstDay = toUnivfiedMMDDYYYY(obj[key][0][0]);
            firstDayKey = key;
          }
    }

    // BUG_FIX_IN_FUTURE
    // attention!!!
    // this function only works for two key pairs, not multiples
    var firstDayReady = false;
    var tmpcounter = 0;
    var tmpcounter_slave = 0;
    for(key in obj){
      if(key != firstDayKey){
          // check if the stock has enough data points
          // if last day is smaller than master begin day, current section must fail
          if(new Date(obj[key][obj[key].length-1][0]) <= new Date(firstDay))
              return false;

          while( firstDayReady === false &&  tmpcounter < obj[key].length){
            while(new Date(obj[key][tmpcounter_slave][0]) <= new Date(firstDay) && firstDayReady === false){
               if(new Date(obj[key][tmpcounter_slave][0]).getTime() === new Date(firstDay).getTime())
                 firstDayReady= true;
               tmpcounter_slave++;
             }
            if(firstDayReady === false)
               tmpcounter++;
            firstDay = obj[firstDayKey][tmpcounter][0];

          }
       }
    }

    // unify firstday
    firstDay = toUnivfiedMMDDYYYY(firstDay);
    for (key in obj) {
        var index = getBeginIndex(obj[key], firstDay);
        if (index != -1) {
            // slice the array
            obj[key] = obj[key].slice(index, obj[key].length);
            // recalculate values
            obj[key] = recalculatePercent(obj[key]);

            graphData[GRAPH_ID].purchasePrice[key] = parseFloat(obj[key][0][2]);

            graphData[GRAPH_ID].purchaseDate[key] = toUnivfiedMMDDYYYY(obj[key][0][0]);
        } else {
            //nothing found switch firstday
            console.log("Failed to unify the begining! " + key);
        }
    }


    //setup masterlen and masterkey
    masterkey = Object.keys(obj)[0]
    masterLen = obj[masterkey].length;

    //fill in the shorter ones
    for (key in obj) {
        // do not process self
        if (key != masterkey) {
            //make sure first element is same
            if (toUnivfiedMMDDYYYY(obj[key][0][0]) !=
                toUnivfiedMMDDYYYY(obj[masterkey][0][0]))
            // first key is not equal
            {
                console.log("Vlidate Failed due to first date not equal" + key);
            }

            // begining process
            var cindex = 0;
            var masterDate = "";
            var currentDate = "";
            var lastEffectiveIndex = 0;
            for (var i = 0; i < masterLen; i++) {
                if(i == 210 && Loquacious)
                    console.log(210);
                masterDate = toUnivfiedMMDDYYYY(obj[masterkey][i][0]);
                if(obj[key][cindex] != undefined){
                currentDate = toUnivfiedMMDDYYYY(obj[key][cindex][0]);
                lastEffectiveIndex = cindex;
                } else{
                // out of range , start to insert blank data
                currentDate = toUnivfiedMMDDYYYY(obj[key][lastEffectiveIndex][0]);

                }
                if (currentDate != masterDate) {
                    //check for removal
                    if (new Date(currentDate) < new Date(masterDate)) {
                        // array remove that date
                        obj[key].splice(cindex, 1);
                        var tmpdate = obj[key][lastEffectiveIndex][0];
                        while((new Date(tmpdate) < new Date(masterDate))&& lastEffectiveIndex != obj[key].length-1){
                          obj[key].splice(cindex, 1);
                          tmpdate = obj[key][lastEffectiveIndex][0];
                        }
                        //update on that date to current with no
                    } else {
                        var selectIndex = findLastNoneEmptyEntry(masterDate, obj[key], cindex);
                        //insert into the key
                        obj[key].splice(selectIndex + 1, 0, [masterDate, obj[key][selectIndex][1], obj[key][selectIndex][2]]);
                        obj[key].join();
                    }
                }
                // continue here tomorrow, check array and test with google
                cindex++;
            }
            // clean up the tail
            if (obj[key].length > masterLen) {
                var diff = (obj[key].length - masterLen);
                obj[key].removeLastN(diff);

            } else if(obj[key].length < masterLen){
                // data ended earlier than master
                var diff = (masterLen-obj[key].length);
                for(var i =0 ; i < diff; i ++)
                    obj[key].push([obj[masterkey][masterLen-1][0],obj[key][obj[key].length-1][1],obj[key][obj[key].length-1][2]])
            }

            if (obj[key].length != masterLen) {
                console.log("Validate Failed!! Invalid length for " + key + " with length: " + obj[key].length);
                return false;
            }

        }
    }

    return obj;

}


function recalculatePercent(obj) {
    var purchasePrice = parseFloat(obj[0][2]);
    for (var i = 0; i < obj.length; i++) {
        obj[i][1] = ((obj[i][2] - purchasePrice) / purchasePrice * 100).toFixed(2);
    }
    return obj;
}

function getDataLength(dataLen) {
    var offset = +16;
    var d = new Date();
    var utc = d.getTime() - (d.getTimezoneOffset() * 60000);
    var nd = new Date(utc + (3600000 * offset));
    switch(dataLen){
        case 'y':
        nd.setFullYear(nd.getFullYear() - 1);
        break;

        case 'hy':
        nd.setMonth(nd.getMonth() - 6);
        break;

        case '2y':
        nd.setFullYear(nd.getFullYear()-2);

        default:
        nd.setFullYear(nd.getFullYear() - 1);
        break;

    }

    return ((nd.getMonth() + 1) + "/" + nd.getDate() + "/" + nd.getFullYear());
}

/*
var image = document.getElementById('rainDay');
image.onload = function() {
    var engine = new RainyDay({
        image: this,
        gravityAngle: Math.PI / 3,
        opacity:0.8,
        blur:0
    });
//    engine.rain([ [1, 2, 200] ]);
    engine.trail = engine.TRAIL_SM0E;
    engine.rain([ [12, 0.005, 0.005],[6, 0.005, 0.015],[1, 0, 10],[1, 0.002, 0.005],[3, 0.002, 0.005] ], 10);
};
image.crossOrigin = 'anonymous';
image.src = 'img/skyback_main.jpg';
*/

</script>
        <!-- content -->
 <script src="js/rain.min.js?do=123222232222"></script>
        </body>
</html>


<!-- references
    // m, q, hy, y,try,fiy,sy,se

    m -> month
    q -> 3 month
    hy -> 6 month
    y -> 1 year
    try -> 3 year
    fiy -> 5 year
    sy -> year to date
    se -> max

    获得期货排名
    http://webftcn.hermes.hexun.com/shf/sortlist?block=741&number=100&title=5&commodityid=0&direction=0&start=0&column=code,name,price,updown,volume,open,vibrationRatio&callback=hx_json81462035658518
        !-->
